<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Expense Tracker ‚Äî Filters Side-by-side Labels</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg: linear-gradient(180deg,#041223 0%, #071427 100%);
  --surface: linear-gradient(180deg,#071427 0%, #071827 100%);
  --muted: #9aa4b2;
  --text: #e6eef6;
  --accent:#7c3aed;
  --success:#1f9f3f;
  --danger:#7a0e0e;
  --card-border: rgba(255,255,255,0.04);
  --file-bg: rgba(255,255,255,0.02);
  --shadow: 0 8px 28px rgba(2,6,23,0.5);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
.light{ --bg: linear-gradient(180deg,#ffffff 0%, #f5f7fb 100%); --surface:#fff; --muted:#6b7280; --text:#0b1220; --card-border: rgba(0,0,0,0.06); }
input[type="file"]{ position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0); }
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow-x:hidden;-webkit-text-size-adjust:100%}
input, select, textarea{ font-size:16px }

/* container */
.wrap{max-width:1300px;margin:16px auto;padding:14px}
header{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px}
.lead{color:var(--muted);font-size:13px;margin-top:4px}

/* Controls layout (rows preserved) */
.controls{display:block;gap:12px;margin-top:14px}
.row{display:flex;gap:12px;margin-bottom:10px;align-items:stretch}
.row .col{flex:1;min-width:0}
.row .col.small{flex:0 0 220px}
.row .col.filecol{flex:1 1 100%}

/* CONTROL BOX now uses row layout (label beside field) on wide screens */
.control-box{
  background:var(--file-bg);
  padding:10px;
  border-radius:10px;
  border:1px solid var(--card-border);
  box-sizing:border-box;
  display:flex;
  align-items:center;
  gap:10px;
  flex-direction:row;            /* LABEL and FIELD side-by-side */
}

/* label on left, field to right */
.control-box label{
  display:block;
  font-size:13px;
  color:var(--muted);
  min-width:20px;              /* left column width for labels */
  text-align:left;
}

/* Make pie dropdowns match Daily-month select styling */
#ytd-pie-mode,
#monthly-pie-mode,
#monthly-pie-month {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--card-border);
  background: transparent;
  color: var(--text);
  box-sizing: border-box;
  height: 44px;
  font-size: 14px;
  -webkit-appearance: none; /* removes default arrow styling in some browsers */
  appearance: none;
}

/* If you want a small arrow icon on the right (optional), add this wrapper in HTML or use background-image */
#monthly-pie-month { min-width: 160px; } /* ensure it doesn't get truncated */

/* field container stretches */
.control-box .field{ flex:1; min-width:0 }

/* inputs uniform size */
.control-box input[type="text"],
.control-box input[type="date"],
.control-box input[type="number"],
.control-box select{
  width:100%;
  height:44px;
  padding:8px 10px;
  border-radius:8px;
  border:1px solid var(--card-border);
  background:transparent;
  color:var(--text);
  box-sizing:border-box;
  font-size:14px;
}

/* file row */
.file-row{display:flex;gap:8px;align-items:center}
.file-label{
  display:inline-block;       /* ensure text-overflow works */
  max-width:220px;           /* adjust this value as needed */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ensure filename doesn't push layout ‚Äî keep it on one line and ellipsis */
#file-name{
  max-width: calc(100% - 240px); /* leaves space for the button; adjust if you change button max-width */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  display:inline-block;
}
/* buttons */
.btn{background:linear-gradient(90deg,#6ee7b7,#34d399);color:#032;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;height:48px; min-width:140px}
.btn.secondary{background:transparent;border:1px solid var(--card-border);color:var(--text);padding:8px 12px;border-radius:8px;height:48px; min-width:140px}
.remarks-input{width:100%;height:44px;padding:8px 10px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text);font-size:14px;box-sizing:border-box}

/* ensure control-box visual height */
.row .col .control-box{height:64px;display:flex;flex-direction:row;align-items:center}
.row .col .control-box .field > *{height:44px}

/* buttons row centered and wider */
.row.buttons-row{justify-content:center}
.row.buttons-row .col{flex:0 0 auto}
.row.buttons-row .col > div{display:flex;gap:18px;align-items:center;justify-content:center}
.row.buttons-row .btn, .row.buttons-row .btn.secondary{min-width:180px;padding-left:18px;padding-right:18px}

/* Responsive: on narrow screens stack label above field */
@media (max-width:900px){
  .row{flex-direction:column}
  .control-box{flex-direction:column;align-items:stretch;height:auto;padding:10px}
  .control-box label{min-width:0;margin-bottom:6px}
  .control-box .field > *{height:44px}
  #file-name{white-space:normal}
  .row .col.small{flex:1}
  .btn{min-width:120px}
}

/* Keep rest unchanged */
.top-charts{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:18px}
.card{background:var(--surface);border-radius:12px;padding:12px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
.card h3{margin:0;font-size:14px}
.chart-frame{width:100%;height: 200px;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;margin-top:8px}
.pie-chart-frame{width:75%;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;margin-top:8px}

.pie-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.summary-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.transactions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}

table{width:100%;border-collapse:collapse}
thead th{color:var(--muted);font-weight:600;background:linear-gradient(90deg,rgba(0,0,0,0.02),transparent)}
th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);font-size:13px;color:var(--text);text-align:left}
.amount.credit{color:var(--success);font-weight:700}
.amount.debit{color:var(--danger);font-weight:700}

td.remarks{white-space:normal;word-break:break-word;max-width:420px}
@media (max-width:1100px){ .top-charts{grid-template-columns:1fr} .pie-row{grid-template-columns:1fr} .summary-row{grid-template-columns:1fr} .transactions{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div>
        <h1>Expense Tracker</h1>
        <div class="lead">Upload XLS/XLSX ‚Äî Dates dd/mm/yyyy ‚Äî Currency INR</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="theme-toggle" class="btn secondary">Toggle Theme</button>
        <button id="export-pdf" class="btn secondary">Export PDF</button>
      </div>
    </header>

    <div class="controls">

      <!-- Row 1: Choose file -->
      <div class="row">
        <div class="col filecol">
          <div class="control-box file-row">
            <label class="file-label" for="file-input">üìÅ Choose file</label>
            <input id="file-input" type="file" accept=".xls,.xlsx" />
            <div id="file-name">No file chosen</div>
          </div>
        </div>
      </div>

      <!-- Row 2: From | To | Month -->
      <div class="row">
        <div class="col small">
          <div class="control-box">
            <label for="from-date">From</label>
            <div class="field"><input id="from-date" type="date" /></div>
          </div>
        </div>
        <div class="col small">
          <div class="control-box">
            <label for="to-date">To</label>
            <div class="field"><input id="to-date" type="date" /></div>
          </div>
        </div>
        <div class="col">
          <div class="control-box">
            <label for="month-select">Month</label>
            <div class="field"><select id="month-select"><option value="">--optional--</option></select></div>
          </div>
        </div>
      </div>

      <!-- Row 3: Min | Max | Remarks (remarks beside min/max) -->
      <div class="row">
        <div class="col small">
          <div class="control-box">
            <label for="min-amt">Min (INR)</label>
            <div class="field"><input id="min-amt" type="number" /></div>
          </div>
        </div>
        <div class="col small">
          <div class="control-box">
            <label for="max-amt">Max (INR)</label>
            <div class="field"><input id="max-amt" type="number" /></div>
          </div>
        </div>
        <div class="col">
          <div class="control-box">
            <label for="search-remarks">Search Remarks</label>
            <div class="field"><input id="search-remarks" class="remarks-input" type="text" placeholder="search (case-insensitive)"/></div>
          </div>
        </div>
      </div>

      <!-- Row 4: Apply & Clear centered -->
      <div class="row buttons-row">
        <div class="col" style="flex:0 0 auto;">
          <div>
            <button id="apply-filters" class="btn">Apply</button>
            <button id="clear-filters" class="btn secondary">Clear</button>
          </div>
        </div>
      </div>

    </div>

    <!-- Rest of app (unchanged) -->
    <div class="top-charts">
      <div class="card">
        <h3>Monthly Spendings ‚Äî Visual</h3>
        <div class="chart-frame"><canvas id="monthly-chart"></canvas></div>
      </div>
      <div class="card">
        <h3>Daily Spend ‚Äî Selected Month</h3>
        <div style="margin-top:8px"><select id="daily-month-select" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)"></select></div>
        <div class="chart-frame"><canvas id="daily-chart"></canvas></div>
      </div>
      <div class="card">
        <h3>Average Daily Spending</h3>
        <div class="chart-frame"><canvas id="avg-line-chart"></canvas></div>
      </div>
    </div>

    <div class="pie-row">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">YTD Spend Distribution</h3>
          <div><select id="ytd-pie-mode"><option value="transactions">Transactions</option><option value="spends">Spends</option></select></div>
        </div>
        <div class="pie-chart-frame"><canvas id="ytd-bins-pie-chart"></canvas></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Monthly Spend Distribution</h3>
          <div style="display:flex;gap:8px"><select id="monthly-pie-month"></select><select id="monthly-pie-mode"><option value="transactions">Transactions</option><option value="spends">Spends</option></select></div>
        </div>
        <div class="pie-chart-frame"><canvas id="monthly-bins-pie-chart"></canvas></div>
      </div>
    </div>

    <div class="summary-row">
      <div class="card">
        <h3>Monthly Spending</h3>
        <div style="max-height:240px;overflow:auto;margin-top:8px"><table id="monthly-table"><thead><tr><th>Month</th><th style="text-align:right">Total</th></tr></thead><tbody></tbody></table></div>
      </div>
      <div class="card">
        <h3>Average Daily Spending</h3>
        <div style="max-height:240px;overflow:auto;margin-top:8px"><table id="avg-table"><thead><tr><th>Month</th><th style="text-align:right">Avg/day</th></tr></thead><tbody></tbody></table></div>
        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="flex:1"><div class="muted">Credits</div><div id="total-credits" style="font-weight:700;margin-top:6px">‚Çπ0</div></div>
          <div style="flex:1"><div class="muted">Debits</div><div id="total-debits" style="font-weight:700;margin-top:6px">‚Çπ0</div></div>
          <div style="flex:1"><div class="muted">Net</div><div id="net-total" style="font-weight:700;margin-top:6px">‚Çπ0</div></div>
        </div>
      </div>
    </div>

    <div class="transactions">
      <div class="card"><h3>Credits</h3><div style="max-height:360px;overflow:auto;margin-top:8px"><table id="credits-table"><thead><tr><th>Date</th><th>Amount</th><th>Remarks</th></tr></thead><tbody></tbody></table></div></div>
      <div class="card"><h3>Debits</h3><div style="max-height:360px;overflow:auto;margin-top:8px"><table id="debits-table"><thead><tr><th>Date</th><th>Amount</th><th>Remarks</th></tr></thead><tbody></tbody></table></div></div>
    </div>

  </div>

<script>
// Full JS (unchanged) ‚Äî this is the same logic you already have: parsing XLSX, filtering, rendering charts, PDF export.
// I paste the complete JS here to make the file runnable. This code is the same as your previous working version, unchanged
// except where necessary to reference the DOM which we didn't rename.

function parseDateDMY(str){ if(!str) return null; if(str instanceof Date && !isNaN(str)) return str; str=String(str).trim(); const m=str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/); if(m){ let d=parseInt(m[1],10), mo=parseInt(m[2],10)-1, y=parseInt(m[3],10); if(y<100) y=2000+y; const dt=new Date(y,mo,d); if(!isNaN(dt)) return dt;} const dt2=new Date(str); if(!isNaN(dt2)) return dt2; return null; }
function formatINR(num){ if(num==null||num==='') return ''; const n=Number(num); if(isNaN(n)) return ''; return '‚Çπ'+n.toLocaleString('en-IN',{maximumFractionDigits:2}); }
function monthKey(dt){ return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0'); }
function monthLabelFromKey(key){ const [y,m]=key.split('-').map(Number); return new Date(y,m-1,1).toLocaleString('en-GB',{month:'short',year:'numeric'}); }
function daysInMonthFromKey(key){ const [y,m]=key.split('-').map(Number); return new Date(y,m,0).getDate(); }
function totalColor(total){ if(total < 15000) return '#35760A'; else if(total >= 15000 && total < 25000) return '#EF8652'; else if(total >= 25000 && total < 30000) return '#EF3C3C'; else return '#c0392b'; }
function avgColor(avg){ if(avg < 700) return '#35760A'; else if(avg >= 700 && avg < 1200) return '#EF8652'; else if(avg >= 1200 && avg < 1500) return '#EF3C3C'; else return '#c0392b'; }

const BINS = [
  {label:'1-500', min:1, max:500},
  {label:'501-1000', min:501, max:1000},
  {label:'1001-1500', min:1001, max:1500},
  {label:'1501-2000', min:1501, max:2000},
  {label:'2001-3000', min:2001, max:3000},
  {label:'3001-5000', min:3001, max:5000},
  {label:'>5000', min:5001, max:Infinity},
];
const BIN_COLORS = ['#6EE7B7','#F9C74F','#EF8652','#EF3C3C','#D64550','#A93226','#7a0e0e'];

let transactions=[], filtered=[];
let monthlyChart=null,dailyChart=null,avgLineChart=null,ytdBinsPie=null,monthlyBinsPie=null;
let currentTheme='dark';

function detectColumns(headerRow){
  const mapping={};
  for(let i=0;i<headerRow.length;i++){
    const h=String(headerRow[i]||'').toLowerCase().replace(/\s+/g,'');
    if(/date/.test(h)) mapping.date=i;
    if(/deposit|credit|depositamount|deposit_amt/.test(h)) mapping.deposit=i;
    if(/withdrawal|debit|withdrawalamount|withdraw_amt/.test(h)) mapping.withdrawal=i;
    if(/remark|remarks|transactionremarks|narration|description/.test(h)) mapping.remarks=i;
  }
  return mapping;
}

function readWorkbookData(wb){
  const firstSheet = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: true });
  if(!json || json.length === 0) return [];

  const startRowIndex = 12; // row 13
  const startColIndex = 1;  // column B

  if(json.length <= startRowIndex){
    // fallback to old behavior
    const header = json[0] || [];
    const map = detectColumns(header);
    const rows = [];
    for(let r=1;r<json.length;r++){
      const row = json[r]; if(!row) continue; if(row.every(c=>c===undefined||c==='')) continue;
      const rawDate = map.date !== undefined ? row[map.date] : row[0];
      let dt = null;
      if(typeof rawDate === 'number'){ const parsed = XLSX.SSF.parse_date_code(rawDate); if(parsed) dt = new Date(parsed.y, parsed.m-1, parsed.d); } else dt = parseDateDMY(rawDate);
      const deposit = map.deposit !== undefined ? row[map.deposit] : '';
      const withdrawal = map.withdrawal !== undefined ? row[map.withdrawal] : '';
      const remarks = map.remarks !== undefined ? row[map.remarks] : '';
      rows.push({ date: dt, deposit: deposit, withdrawal: withdrawal, remarks: String(remarks || '') });
    }
    return rows;
  }

  const rawHeaderRow = json[startRowIndex] || [];
  const headerRow = rawHeaderRow.slice(startColIndex);
  const map = detectColumns(headerRow);

  const rows = [];
  for(let r = startRowIndex + 1; r < json.length; r++){
    const fullRow = json[r] || [];
    const rowSlice = fullRow.slice(startColIndex);
    if(rowSlice.every(c => c === undefined || c === '')) continue;
    const rawDate = map.date !== undefined ? rowSlice[map.date] : rowSlice[0];
    let dt = null;
    if(typeof rawDate === 'number'){ const parsed = XLSX.SSF.parse_date_code(rawDate); if(parsed) dt = new Date(parsed.y, parsed.m-1, parsed.d); } else dt = parseDateDMY(rawDate);
    const deposit = map.deposit !== undefined ? rowSlice[map.deposit] : (rowSlice[1] || '');
    const withdrawal = map.withdrawal !== undefined ? rowSlice[map.withdrawal] : (rowSlice[2] || '');
    const remarks = map.remarks !== undefined ? rowSlice[map.remarks] : (rowSlice[3] || '');
    rows.push({ date: dt, deposit: deposit, withdrawal: withdrawal, remarks: String(remarks || '') });
  }

  return rows;
}

function normalize(rows){ const out=[]; rows.forEach(r=>{ if(!r.date) return; const d=(r.date instanceof Date)? r.date : parseDateDMY(r.date); if(!d) return; const deposit=Number(String(r.deposit||'').replace(/[^0-9.-]+/g,''))||0; const withdrawal=Number(String(r.withdrawal||'').replace(/[^0-9.-]+/g,''))||0; out.push({date:new Date(d.getFullYear(),d.getMonth(),d.getDate()),deposit,withdrawal,remarks:r.remarks||''}); }); return out.sort((a,b)=>a.date-b.date); }

function populateMonthSelects(){
  const set = new Set(transactions.map(t=>monthKey(t.date)));
  const arr = Array.from(set).sort();
  const monthSelect=document.getElementById('month-select');
  const daily=document.getElementById('daily-month-select');
  const monthlyPie=document.getElementById('monthly-pie-month');
  monthSelect.innerHTML='<option value="">--optional--</option>';
  if(daily) daily.innerHTML='<option value="">--select--</option>';
  if(monthlyPie) monthlyPie.innerHTML='<option value="">--select--</option>';
  arr.forEach(k=>{
    const o=document.createElement('option'); o.value=k; o.textContent=monthLabelFromKey(k); monthSelect.appendChild(o);
    if(daily){ const o2=o.cloneNode(true); daily.appendChild(o2); }
    if(monthlyPie){ const o3=o.cloneNode(true); monthlyPie.appendChild(o3); }
  });
  if(arr.length){ if(daily) daily.value = arr[0]; if(monthlyPie) monthlyPie.value = arr[0]; }
}

document.getElementById('file-input').addEventListener('change', function(e){
  const f = e.target.files[0];
  document.getElementById('file-name').textContent = f? f.name : 'No file chosen';
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    let wb;
    try{ wb = XLSX.read(ev.target.result, {type:'binary'}); } catch(err){ alert('Failed to read file: '+err); return; }
    const raw = readWorkbookData(wb);
    transactions = normalize(raw);
    populateMonthSelects();
    filtered = transactions.slice();
    renderAll();
    initMutualFilters();
  };
  reader.readAsBinaryString(f);
});

document.getElementById('apply-filters').addEventListener('click', applyFiltersAndRender);
document.getElementById('clear-filters').addEventListener('click', ()=>{
  document.getElementById('from-date').value=''; document.getElementById('to-date').value=''; document.getElementById('month-select').value='';
  document.getElementById('min-amt').value=''; document.getElementById('max-amt').value=''; document.getElementById('search-remarks').value='';
  filtered = transactions.slice(); renderAll();
});

const fromDateEl = document.getElementById('from-date');
const toDateEl   = document.getElementById('to-date');
const monthSelEl = document.getElementById('month-select');

function setMonthDisabled(disabled){ monthSelEl.disabled = disabled; monthSelEl.style.opacity = disabled ? '0.5' : '1'; }
function setDatesDisabled(disabled){ fromDateEl.disabled = disabled; toDateEl.disabled = disabled; fromDateEl.style.opacity = disabled ? '0.5' : '1'; toDateEl.style.opacity = disabled ? '0.5' : '1'; }

monthSelEl.addEventListener('change', ()=>{
  if(monthSelEl.value){ setDatesDisabled(true); fromDateEl.value = ''; toDateEl.value = ''; } else { setDatesDisabled(false); }
});

[fromDateEl, toDateEl].forEach(el=>{
  el.addEventListener('input', ()=>{
    const hasRange = (fromDateEl.value && fromDateEl.value.trim()!=='') || (toDateEl.value && toDateEl.value.trim()!=='');
    if(hasRange){ monthSelEl.value = ''; setMonthDisabled(true); } else { setMonthDisabled(false); }
  });
});

function initMutualFilters(){ const hasRange = (fromDateEl.value && fromDateEl.value.trim()!=='') || (toDateEl.value && toDateEl.value.trim()!==''); setMonthDisabled(hasRange); setDatesDisabled(!!monthSelEl.value); }

function applyFiltersAndRender(){
  const fromDate = document.getElementById('from-date').value ? new Date(document.getElementById('from-date').value) : null;
  const toDate = document.getElementById('to-date').value ? new Date(document.getElementById('to-date').value) : null;
  if(toDate) toDate.setHours(23,59,59,999);
  const monthSel = document.getElementById('month-select').value;
  const minAmt = Number(document.getElementById('min-amt').value) || null;
  const maxAmt = Number(document.getElementById('max-amt').value) || null;
  const search = (document.getElementById('search-remarks').value || '').toLowerCase();

  filtered = transactions.filter(t=>{
    if(fromDate && t.date < fromDate) return false;
    if(toDate && t.date > toDate) return false;
    if(monthSel){ const [y,m]=monthSel.split('-').map(Number); if(!(t.date.getFullYear()===y && (t.date.getMonth()+1)===m)) return false; }
    const amt = t.deposit>0? t.deposit : (t.withdrawal>0? t.withdrawal : 0);
    if(minAmt !== null && minAmt>0 && amt < minAmt) return false;
    if(maxAmt !== null && maxAmt>0 && amt > maxAmt) return false;
    if(search && !String(t.remarks||'').toLowerCase().includes(search)) return false;
    return true;
  });
  renderAll();
}

function destroyIfExists(o){ try{ if(o) o.destroy(); }catch(e){} }
function renderTables(){ const ctbody=document.querySelector('#credits-table tbody'); const dtbody=document.querySelector('#debits-table tbody'); ctbody.innerHTML=''; dtbody.innerHTML=''; filtered.forEach(t=>{ if(t.deposit && t.deposit>0){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.date.toLocaleDateString('en-GB')}</td><td><span class="amount credit">${formatINR(t.deposit)}</span></td><td class="remarks">${t.remarks||''}</td>`; ctbody.appendChild(tr); } if(t.withdrawal && t.withdrawal>0){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.date.toLocaleDateString('en-GB')}</td><td><span class="amount debit">${formatINR(t.withdrawal)}</span></td><td class="remarks">${t.remarks||''}</td>`; dtbody.appendChild(tr); } }); }

function renderMonthlyTable(){ const map=new Map(); filtered.forEach(t=>{ const k=monthKey(t.date); map.set(k,(map.get(k)||0)+(t.withdrawal||0)); }); const tbody=document.querySelector('#monthly-table tbody'); tbody.innerHTML=''; Array.from(map.keys()).sort().forEach(k=>{ const total=map.get(k); const tr=document.createElement('tr'); tr.innerHTML=`<td>${monthLabelFromKey(k)}</td><td style="text-align:right;color:${totalColor(total)}">${formatINR(total)}</td>`; tbody.appendChild(tr); }); }

function renderAvgTable(){ const map=new Map(); filtered.forEach(t=>{ const k=monthKey(t.date); map.set(k,(map.get(k)||0)+(t.withdrawal||0)); }); const tbody=document.querySelector('#avg-table tbody'); tbody.innerHTML=''; Array.from(map.keys()).sort().forEach(k=>{ const total=map.get(k); const days=daysInMonthFromKey(k); const avg=days? total/days:0; const tr=document.createElement('tr'); tr.innerHTML=`<td>${monthLabelFromKey(k)}</td><td style="text-align:right;color:${avgColor(avg)}">${formatINR(avg)}</td>`; tbody.appendChild(tr); }); }

function renderTotals(){ const credits=filtered.reduce((s,t)=>s+(t.deposit||0),0); const debits=filtered.reduce((s,t)=>s+(t.withdrawal||0),0); document.getElementById('total-credits').textContent=formatINR(credits); document.getElementById('total-debits').textContent=formatINR(debits); document.getElementById('net-total').textContent=formatINR(credits-debits); }
function firstMonthKeyInFiltered(){ if(!filtered.length) return ''; const s=new Set(filtered.map(t=>monthKey(t.date))); const arr=Array.from(s).sort(); return arr[0]||''; }

function renderMonthlyChart(){
  // build totals per month (same logic you already have)
  const map = new Map();
  filtered.forEach(t=>{
    const k = monthKey(t.date);
    map.set(k, (map.get(k) || 0) + (t.withdrawal || 0));
  });
  const keys = Array.from(map.keys()).sort();
  const labels = keys.map(k => monthLabelFromKey(k));
  const totals = keys.map(k => map.get(k) || 0);
  const pointColors = totals.map(total => totalColor(total));
  const lineColor = '#4AA3FF';

  // keep existing container (no resizing of outer frame) but ensure canvas fills it
  const container = document.querySelector('.chart-frame');
  const canvas = document.getElementById('monthly-chart');
  canvas.style.width = '100%';
  // try to keep a decent visible height; do not force huge sizes
  if(!canvas.style.height || canvas.style.height === '') canvas.style.height = (container && container.clientHeight ? container.clientHeight : 220) + 'px';

  // destroy previous chart if exists
  if(monthlyChart){ monthlyChart.destroy(); monthlyChart = null; }

  // create a line chart ‚Äî horizontal feel is retained by labeling y axis with months (but Chart.js draws x-axis numeric)
  monthlyChart = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total Spend (INR)',
        data: totals,
        borderColor: lineColor,
        borderWidth: 2.5,
        tension: 0.25,
        fill: false,
        pointRadius: 6,
        pointHoverRadius: 8,
        // color each point according to totalColor
        pointBackgroundColor: pointColors,
        pointBorderColor: pointColors,
        pointBorderWidth: 1.5,
        // draw small area under line optionally (set to transparent if you don't want)
        backgroundColor: 'rgba(74,163,255,0.07)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(ctx){ return '‚Çπ' + Number(ctx.parsed.y || ctx.parsed).toLocaleString('en-IN'); } } } },
      scales: {
        x: {
          ticks: { autoSkip: false },
          grid: { display: false },
          title: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(v){ return v >= 1000 ? '‚Çπ' + Number(v).toLocaleString('en-IN') : '‚Çπ' + v; }
          },
          grid: { color: 'rgba(255,255,255,0.04)' }
        }
      },
      layout: { padding: { top: 8, bottom: 8, left: 6, right: 6 } }
    }
  });
}

function renderDailyChart(monthKeyValue){ const pick = monthKeyValue || document.getElementById('daily-month-select')?.value || firstMonthKeyInFiltered(); if(!pick){ destroyIfExists(dailyChart); return; } const [y,m]=pick.split('-').map(Number); const days=new Date(y,m,0).getDate(); const dayTotals=Array(days).fill(0); filtered.forEach(t=>{ if(t.date.getFullYear()===y && (t.date.getMonth()+1)===m) dayTotals[t.date.getDate()-1]+= (t.withdrawal||0); }); const labels=Array.from({length:days},(_,i)=>String(i+1)); const ctx=document.getElementById('daily-chart').getContext('2d'); destroyIfExists(dailyChart); dailyChart = new Chart(ctx,{type:'line',data:{labels,datasets:[{data:dayTotals,label:monthLabelFromKey(pick),borderColor:'#FF7A59',backgroundColor:'#FF7A5933',fill:true,tension:0.25}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'‚Çπ'+Number(v).toISOString? Number(v).toLocaleString('en-IN') : v}}}}}); }

function renderAvgLineChart(){ const map=new Map(); filtered.forEach(t=>{ const k=monthKey(t.date); map.set(k,(map.get(k)||0)+(t.withdrawal||0)); }); const keys=Array.from(map.keys()).sort(); const labels=keys.map(k=>monthLabelFromKey(k)); const avgs=keys.map(k=>{ const total=map.get(k); const days=daysInMonthFromKey(k); return days? total/days:0; }); const ctx=document.getElementById('avg-line-chart').getContext('2d'); destroyIfExists(avgLineChart); avgLineChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{data:avgs,label:'Avg / day',borderColor:'#4AA3FF',backgroundColor:'#4AA3FF33',fill:true,tension:0.25}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'‚Çπ'+Number(v).toLocaleString('en-IN')}}}}}); }

function renderYtdBinsPie(){ const mode=document.getElementById('ytd-pie-mode').value||'transactions'; const counts=Array(BINS.length).fill(0); const totals=Array(BINS.length).fill(0); filtered.forEach(t=>{ const amt=t.withdrawal||0; if(amt<=0) return; for(let i=0;i<BINS.length;i++){ const b=BINS[i]; if(amt>=b.min && amt<=b.max){ counts[i]++; totals[i]+=amt; break;} if(b.max===Infinity && amt>=b.min){ counts[i]++; totals[i]+=amt; break;} }}); const dataArr = (mode==='transactions')?counts:totals.map(v=>Math.round(v)); const labels=BINS.map((b,i)=>`${b.label} (${counts[i]||0})`); const ctx=document.getElementById('ytd-bins-pie-chart').getContext('2d'); destroyIfExists(ytdBinsPie); ytdBinsPie=new Chart(ctx,{type:'pie',data:{labels,datasets:[{data:dataArr,backgroundColor:BIN_COLORS}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom'}}}}); }

function renderMonthlyBinsPie(){ const monthKeyVal=document.getElementById('monthly-pie-month').value; const mode=document.getElementById('monthly-pie-mode').value||'transactions'; const ctx=document.getElementById('monthly-bins-pie-chart').getContext('2d'); if(!monthKeyVal){ destroyIfExists(monthlyBinsPie); ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); return; } const [y,m]=monthKeyVal.split('-').map(Number); const counts=Array(BINS.length).fill(0); const totals=Array(BINS.length).fill(0); filtered.forEach(t=>{ if(!(t.date.getFullYear()===y && (t.date.getMonth()+1)===m)) return; const amt=t.withdrawal||0; if(amt<=0) return; for(let i=0;i<BINS.length;i++){ const b=BINS[i]; if(amt>=b.min && amt<=b.max){ counts[i]++; totals[i]+=amt; break;} if(b.max===Infinity && amt>=b.min){ counts[i]++; totals[i]+=amt; break;} }}); const dataArr=(mode==='transactions')?counts:totals.map(v=>Math.round(v)); const labels=BINS.map((b,i)=>`${b.label} (${counts[i]||0})`); destroyIfExists(monthlyBinsPie); monthlyBinsPie=new Chart(ctx,{type:'pie',data:{labels,datasets:[{data:dataArr,backgroundColor:BIN_COLORS}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom'}}}}); }

function renderAll(){ renderTables(); renderMonthlyTable(); renderAvgTable(); renderTotals(); renderMonthlyChart(); renderYtdBinsPie(); renderMonthlyBinsPie(); renderDailyChart(document.getElementById('daily-month-select')?.value || firstMonthKeyInFiltered()); renderAvgLineChart(); }

document.getElementById('ytd-pie-mode').addEventListener('change', renderYtdBinsPie);
document.getElementById('monthly-pie-mode').addEventListener('change', renderMonthlyBinsPie);
document.getElementById('monthly-pie-month').addEventListener('change', renderMonthlyBinsPie);
document.getElementById('daily-month-select')?.addEventListener('change', (e)=> renderDailyChart(e.target.value));

document.getElementById('theme-toggle').addEventListener('click', ()=>{ const html=document.documentElement; if(html.classList.contains('light')){ html.classList.remove('light'); currentTheme='dark'; } else { html.classList.add('light'); currentTheme='light'; } setTimeout(()=>renderAll(),80); });

document.getElementById('export-pdf').addEventListener('click', exportFilteredPDF);

function exportFilteredPDF(){
  if(!filtered || filtered.length === 0){ alert('No data to export.'); return; }
  const sanitize = (s) => { if(s===null||s===undefined) return ''; let out=String(s); out = out.replace(/[\u200B\u200C\u200D\uFEFF\u202A-\u202E]/g,''); out = out.replace(/\r\n|\r/g,'\n').replace(/\n+/g,' ').trim(); return out; };

  const win = window.open('', '_blank', 'toolbar=0,location=0,menubar=0');
  if(!win){ alert('Popup blocked. Allow popups for this site and try again.'); return; }

  const imgMonthly = (typeof monthlyChart !== 'undefined' && monthlyChart && monthlyChart.toBase64Image) ? monthlyChart.toBase64Image() : null;
  const imgDaily   = (typeof dailyChart !== 'undefined'   && dailyChart   && dailyChart.toBase64Image)   ? dailyChart.toBase64Image()   : null;
  const imgAvg     = (typeof avgLineChart !== 'undefined' && avgLineChart && avgLineChart.toBase64Image) ? avgLineChart.toBase64Image() : null;
  const imgYtdPie  = (typeof ytdBinsPie !== 'undefined'   && ytdBinsPie   && ytdBinsPie.toBase64Image)   ? ytdBinsPie.toBase64Image()   : null;
  const imgMonthlyPie = (typeof monthlyBinsPie !== 'undefined' && monthlyBinsPie && monthlyBinsPie.toBase64Image) ? monthlyBinsPie.toBase64Image() : null;

  const monthlyMap = new Map(); filtered.forEach(t=>{ const k=monthKey(t.date); monthlyMap.set(k,(monthlyMap.get(k)||0)+(t.withdrawal||0)); }); const monthKeys = Array.from(monthlyMap.keys()).sort();

  let html = `<!doctype html><html><head><meta charset="utf-8"><title>Expense Report</title><style>body{font-family:Inter,system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin:20px;color:#111} .report{max-width:900px;margin:0 auto} h1{margin:0} table{width:100%;border-collapse:collapse;font-size:12px} thead th{background:#f6f8fb;padding:8px;border:1px solid #eee} td{padding:8px;border:1px solid #f3f5f8} .col-date{width:90px} .col-amt{width:110px;text-align:right;font-weight:700} .col-remarks{width:calc(100% - 200px)} .credit{color:#1f9f3f} .debit{color:#c0392b}</style></head><body><div class="report"><h1>Expense Report</h1><div style="margin-top:6px;color:#666">Generated: ${new Date().toLocaleString('en-GB')}</div>`;

  html += `<div style="margin-top:16px;display:flex;gap:12px">`;
  html += `<div style="flex:1">${imgMonthly?`<img src="${imgMonthly}" style="width:100%">`:'<div style="padding:20px;color:#666">Monthly chart not available</div>'}</div>`;
  html += `<div style="flex:1">${imgDaily?`<img src="${imgDaily}" style="width:100%">`:'<div style="padding:20px;color:#666">Daily chart not available</div>'}</div>`;
  html += `<div style="flex:1">${imgAvg?`<img src="${imgAvg}" style="width:100%">`:'<div style="padding:20px;color:#666">Avg chart not available</div>'}</div>`;
  html += `</div>`;

  html += `<div style="margin-top:14px;display:flex;gap:12px">`;
  html += `<div style="flex:1">${imgYtdPie?`<img src="${imgYtdPie}" style="width:100%">`:'<div style="padding:20px;color:#666">YTD pie not available</div>'}</div>`;
  html += `<div style="flex:1">${imgMonthlyPie?`<img src="${imgMonthlyPie}" style="width:100%">`:'<div style="padding:20px;color:#666">Monthly pie not available</div>'}</div>`;
  html += `</div>`;

  html += `<div style="margin-top:16px"><table><thead><tr><th>Month</th><th>Total</th></tr></thead><tbody>`;
  monthKeys.forEach(k=>{ const total = monthlyMap.get(k)||0; html += `<tr><td>${monthLabelFromKey(k)}</td><td style="text-align:right;color:${totalColor(total)}">${formatINR(total)}</td></tr>`; });
  html += `</tbody></table></div>`;

  html += `<div style="margin-top:12px"><table><thead><tr><th class="col-date">Date</th><th class="col-amt">Deposit</th><th class="col-amt">Withdrawal</th><th class="col-remarks">Remarks</th></tr></thead><tbody>`;
  for(let i=0;i<filtered.length;i++){ const t=filtered[i]; const d=t.date?t.date.toLocaleDateString('en-GB'):''; const dep=t.deposit&&t.deposit>0?formatINR(t.deposit):''; const wit=t.withdrawal&&t.withdrawal>0?formatINR(t.withdrawal):''; const rmk=sanitize(t.remarks||''); html += `<tr><td class="col-date">${d}</td><td class="col-amt">${dep?`<span class='credit'>${dep}</span>`:''}</td><td class="col-amt">${wit?`<span class='debit'>${wit}</span>`:''}</td><td class="col-remarks">${rmk}</td></tr>`; }
  html += `</tbody></table></div>`;

  html += `<div style="margin-top:12px;color:#666;font-size:12px">Report generated by Expense Tracker</div>`;
  html += `</div></body></html>`;

  win.document.open(); win.document.write(html); win.document.close();

  let printed = false;
  function tryPrint(){ if(printed) return; try{ printed = true; win.focus(); win.print(); }catch(e){ console.warn('print error', e); } }
  win.addEventListener('load', ()=> setTimeout(tryPrint, 200));
  setTimeout(tryPrint, 1200);
}

/* init empty */
transactions = []; filtered = [];

window.addEventListener('resize', ()=>{ if(monthlyChart||dailyChart||avgLineChart) renderAll(); });
</script>
</body>
</html>
