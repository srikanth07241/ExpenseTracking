<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Investment Planner (Gold / Stock / MF / Real Estate)</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 1rem;
    }

    .card {
      background: #020617;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border: 1px solid #1f2937;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .tab-btn {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      cursor: pointer;
      text-align: center;
      min-width: 0;
    }

    .tab-btn.active {
      background: linear-gradient(135deg,#38bdf8,#22c55e);
      color: #020617;
      border-color: transparent;
      font-weight: 600;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 640px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.85rem;
      color: #d1d5db;
    }

    input, select {
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 16px; /* prevent iOS zoom on focus */
      width: 100%;
    }

    input::placeholder { color: #6b7280; }

    input:focus, select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    .field-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .field-inline span {
      font-size: 0.85rem;
      color: #9ca3af;
      white-space: nowrap;
    }

    .actions {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #022c22;
    }

    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .btn-primary:active,
    .btn-secondary:active {
      transform: translateY(1px);
    }

    .results {
      margin-top: 16px;
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #1f2937;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .summary-item {
      flex: 1 1 120px;
      background: #020617;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #111827;
    }

    .summary-label {
      color: #9ca3af;
      font-size: 0.75rem;
      margin-bottom: 2px;
    }

    .summary-value {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 620px;
    }

    thead { background: #020617; }

    th, td {
      text-align: right;
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
      white-space: nowrap;
    }

    th:first-child, td:first-child { text-align: left; }

    th {
      font-weight: 600;
      color: #9ca3af;
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
    }

    tbody tr:nth-child(even) { background: #020617; }

    .tenure-row {
      background: #111827 !important;
      font-weight: 600;
    }

    .tenure-row td:first-child {
      border-left: 3px solid #22c55e;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #0f172a;
      color: #9ca3af;
      border: 1px solid #1f2937;
    }

    .note {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 6px;
    }

    .error {
      margin-top: 8px;
      color: #fecaca;
      font-size: 0.8rem;
    }

    h3.section-title {
      margin: 4px 0 6px;
      font-size: 0.95rem;
      font-weight: 600;
    }

    /* EMI schedule wrapper (scrollable) */
    .emi-wrapper {
      max-height: 260px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .emi-wrapper table {
      font-size: 0.78rem;
      min-width: 820px;
    }

    /* Print styles */
    @media print {
      *, *::before, *::after {
        background: #ffffff !important;
        color: #000000 !important;
        box-shadow: none !important;
      }

      body {
        margin: 0;
        padding: 0;
      }

      .page { padding: 0; }

      .card {
        border: none !important;
      }

      .actions,
      button {
        display: none !important;
      }

      .table-wrapper,
      .emi-wrapper {
        overflow: visible !important;
        max-height: none !important;
      }

      table {
        min-width: 100% !important;
        font-size: 0.75rem;
      }

      th, td {
        white-space: normal !important;
        border-bottom: 1px solid #dddddd !important;
      }

      th {
        position: static !important;
      }

      .tenure-row td:first-child {
        border-left: 3px solid #22c55e !important;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Investment Planner</h1>
  <div class="subtitle">
    Gold, Stocks, Mutual Funds &amp; Real Estate – step-up SIP &amp; property projections.
  </div>

  <div class="card">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-asset="gold">Gold</button>
      <button class="tab-btn" data-asset="stock">Stock</button>
      <button class="tab-btn" data-asset="mf">Mutual Fund</button>
      <button class="tab-btn" data-asset="realestate">Real Estate</button>
    </div>

    <!-- ====== SIP SECTION (Gold / Stock / MF) ====== -->
    <div id="sipSection">
      <div class="form-grid">
        <!-- Rate field (hidden for MF) -->
        <div class="field" id="goldRateField">
          <label for="goldRate" id="rateLabel">Today's gold rate (₹ per gram)</label>
          <input type="number" id="goldRate" placeholder="e.g. 7500" step="0.01" min="0">
        </div>

        <!-- Frequency -->
        <div class="field">
          <label for="frequency">Investment frequency</label>
          <select id="frequency">
            <option value="yearly">Yearly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <!-- Planned investment -->
        <div class="field">
          <label for="plannedInvestment">Planned investment amount (₹ per period)</label>
          <input type="number" id="plannedInvestment" placeholder="e.g. 100000" step="0.01" min="0">
        </div>

        <!-- Step-up % -->
        <div class="field">
          <label for="stepUp">
            Step-up in investment (% per year)
          </label>
          <div class="field-inline">
            <input type="number" id="stepUp" placeholder="e.g. 5" step="0.01" min="0">
            <span class="badge">applied once every year</span>
          </div>
        </div>

        <!-- Growth rate -->
        <div class="field">
          <label for="growthRate" id="growthLabel">Estimated gold price growth (% per year)</label>
          <input type="number" id="growthRate" placeholder="e.g. 10" step="0.01">
        </div>

        <!-- Inflation rate -->
        <div class="field">
          <label for="inflationRate">Expected inflation (% per year)</label>
          <input type="number" id="inflationRate" placeholder="e.g. 5" step="0.01">
        </div>

        <!-- Tenure -->
        <div class="field">
          <label for="tenureValue" id="tenureLabel">Tenure of investment (years)</label>
          <input type="number" id="tenureValue" placeholder="e.g. 10" min="1" step="1">
        </div>

        <!-- Help text -->
        <div class="field">
          <span class="note">
            Frequency decides tenure unit: yearly → years, monthly → months.
          </span>
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" onclick="calculatePlan()">
          ▶ Calculate
        </button>
        <button class="btn-secondary" id="printBtn" style="display:none;" onclick="window.print()">
          ⬇ Download / Print PDF
        </button>
      </div>

      <div id="errorBox" class="error" style="display:none;"></div>

      <div id="results" class="results" style="display:none;">
        <div class="summary-row">
          <div class="summary-item">
            <div class="summary-label">Total invested over tenure</div>
            <div class="summary-value" id="summaryInvested">₹0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label" id="summaryQtyLabel">Gold accumulated by end of tenure</div>
            <div class="summary-value" id="summaryQty">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Value at end of tenure (nominal)</div>
            <div class="summary-value" id="summaryNominal">₹0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Real value in today's ₹ (inflation-adjusted)</div>
            <div class="summary-value" id="summaryReal">₹0</div>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
            <tr>
              <th>Time</th>
              <th id="qtyHeader">Gold accumulated (g)</th>
              <th>Total invested (₹)</th>
              <th>Nominal value (₹ at that time)</th>
              <th>Real value (₹ in today's money)</th>
            </tr>
            </thead>
            <tbody id="resultsTableBody">
            <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <div class="note">
          Growth is interpreted as % per year (for yearly SIP) or % per month (for monthly SIP).
          Inflation is % per year. Actual returns will differ.
        </div>
      </div>
    </div>

    <!-- ====== REAL ESTATE SECTION ====== -->
    <div id="reSection" style="display:none;">
      <div class="form-grid">
        <div class="field">
          <label for="rePropertyValue">Value of property (₹)</label>
          <input type="number" id="rePropertyValue" placeholder="e.g. 10000000" step="0.01" min="0">
        </div>
        <div class="field">
          <label for="reInvestedSavings">Invested savings / down payment (₹)</label>
          <input type="number" id="reInvestedSavings" placeholder="e.g. 2000000" step="0.01" min="0">
        </div>
        <div class="field">
          <label for="reLoanAmount">Loan amount (₹)</label>
          <input type="number" id="reLoanAmount" placeholder="e.g. 8000000" step="0.01" min="0">
        </div>
        <div class="field">
          <label for="reInterestRate">Loan interest rate (% per year)</label>
          <input type="number" id="reInterestRate" placeholder="e.g. 8.5" step="0.01" min="0">
        </div>
        <div class="field">
          <label for="reLoanTenure">Tenure of loan (years)</label>
          <input type="number" id="reLoanTenure" placeholder="e.g. 20" min="1" step="1">
        </div>
        <div class="field">
          <label for="reRentPerMonth">Estimated rent (₹ per month)</label>
          <input type="number" id="reRentPerMonth" placeholder="e.g. 25000" step="0.01" min="0">
        </div>
        <div class="field">
          <label for="reRentIncrease">Rental increment (% per year)</label>
          <input type="number" id="reRentIncrease" placeholder="e.g. 5" step="0.01" min="0">
        </div>
        <div class="field">
          <label for="reInflation">Estimated average inflation (% per year)</label>
          <input type="number" id="reInflation" placeholder="e.g. 5" step="0.01" min="0">
        </div>
        <div class="field">
          <label for="reAppreciation">Estimated average appreciation of property (% per year)</label>
          <input type="number" id="reAppreciation" placeholder="e.g. 8" step="0.01" min="0">
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" onclick="calculateRealEstate()">
          ▶ Calculate
        </button>
        <button class="btn-secondary" id="rePrintBtn" style="display:none;" onclick="window.print()">
          ⬇ Download / Print PDF
        </button>
      </div>

      <div id="reErrorBox" class="error" style="display:none;"></div>

      <div id="reResults" class="results" style="display:none;">
        <h3 class="section-title">Spent</h3>
        <div class="summary-row">
          <div class="summary-item">
            <div class="summary-label">Down payment (invested savings)</div>
            <div class="summary-value" id="reSummarySavings">₹0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Approx EMI (first month)</div>
            <div class="summary-value" id="reSummaryEmi">₹0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Total principal repaid</div>
            <div class="summary-value" id="reSummaryPrincipal">₹0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Total interest cost</div>
            <div class="summary-value" id="reSummaryInterest">₹0</div>
          </div>
        </div>
        <div class="summary-row">
          <div class="summary-item">
            <div class="summary-label">Total loan payout (principal + interest)</div>
            <div class="summary-value" id="reSummaryLoanPayout">₹0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Total cash outflow (down payment + EMI)</div>
            <div class="summary-value" id="reSummaryTotalOutflow">₹0</div>
          </div>
        </div>

        <h3 class="section-title">Earned</h3>
        <div class="summary-row">
          <div class="summary-item">
            <div class="summary-label">Total rent received by end of loan tenure</div>
            <div class="summary-value" id="reSummaryRent">₹0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Property value at end of tenure (nominal)</div>
            <div class="summary-value" id="reSummaryPropNominal">₹0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Property value in today's money (real)</div>
            <div class="summary-value" id="reSummaryPropReal">₹0</div>
          </div>
        </div>

        <h3 class="section-title">Projections</h3>
        <div class="table-wrapper">
          <table>
            <thead>
            <tr>
              <th>Year</th>
              <th>Total EMI paid so far (₹)</th>
              <th>Total rent received so far (₹)</th>
              <th>Asset value (₹)</th>
              <th>Real asset value (₹, today's money)</th>
            </tr>
            </thead>
            <tbody id="reResultsTableBody">
            <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <h3 class="section-title" id="emiScheduleTitle" style="display:none;">
          EMI Schedule (monthly)
        </h3>
        <div class="emi-wrapper" id="emiScheduleContainer" style="display:none;">
          <table>
            <thead>
            <tr>
              <th>Month #</th>
              <th>Month-Year</th>
              <th>Principal paid (₹)</th>
              <th>Interest paid (₹)</th>
              <th>Total EMI (₹)</th>
              <th>Principal pending (₹)</th>
              <th>% of principal paid</th>
              <th>% of loan paid</th>
            </tr>
            </thead>
            <tbody id="emiScheduleBody">
            <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ===== Common DOM refs =====
  const tabs = document.querySelectorAll('.tab-btn');
  const sipSection = document.getElementById('sipSection');
  const reSection = document.getElementById('reSection');

  // ===== SIP DOM refs =====
  const frequencySelect = document.getElementById('frequency');
  const tenureLabel = document.getElementById('tenureLabel');
  const errorBox = document.getElementById('errorBox');
  const resultsContainer = document.getElementById('results');
  const tableBody = document.getElementById('resultsTableBody');
  const printBtn = document.getElementById('printBtn');

  const goldRateField = document.getElementById('goldRateField');
  const rateLabelEl = document.getElementById('rateLabel');
  const growthLabelEl = document.getElementById('growthLabel');
  const qtyHeaderEl = document.getElementById('qtyHeader');
  const summaryQtyLabelEl = document.getElementById('summaryQtyLabel');
  const summaryQtyValueEl = document.getElementById('summaryQty');

  // ===== Real Estate DOM refs =====
  const reErrorBox = document.getElementById('reErrorBox');
  const reResults = document.getElementById('reResults');
  const rePrintBtn = document.getElementById('rePrintBtn');
  const reTableBody = document.getElementById('reResultsTableBody');

  const reSummarySavings = document.getElementById('reSummarySavings');
  const reSummaryEmi = document.getElementById('reSummaryEmi');
  const reSummaryPrincipal = document.getElementById('reSummaryPrincipal');
  const reSummaryInterest = document.getElementById('reSummaryInterest');
  const reSummaryLoanPayout = document.getElementById('reSummaryLoanPayout');
  const reSummaryTotalOutflow = document.getElementById('reSummaryTotalOutflow');
  const reSummaryRent = document.getElementById('reSummaryRent');
  const reSummaryPropNominal = document.getElementById('reSummaryPropNominal');
  const reSummaryPropReal = document.getElementById('reSummaryPropReal');

  const emiScheduleTitle = document.getElementById('emiScheduleTitle');
  const emiScheduleContainer = document.getElementById('emiScheduleContainer');
  const emiScheduleBody = document.getElementById('emiScheduleBody');

  let currentAsset = 'gold';
  let qtySuffix = ' g';

  const tabState = { gold: {}, stock: {}, mf: {} };

  // For EMI schedule
  let reEmiSchedule = null;

  // ===== SIP helpers for state =====
  function readFormState() {
    return {
      goldRate: document.getElementById('goldRate').value,
      frequency: frequencySelect.value,
      plannedInvestment: document.getElementById('plannedInvestment').value,
      stepUp: document.getElementById('stepUp').value,
      growthRate: document.getElementById('growthRate').value,
      inflationRate: document.getElementById('inflationRate').value,
      tenureValue: document.getElementById('tenureValue').value
    };
  }

  function applyFormState(state) {
    if (!state) return;
    document.getElementById('goldRate').value = state.goldRate ?? '';
    frequencySelect.value = state.frequency ?? 'yearly';
    document.getElementById('plannedInvestment').value = state.plannedInvestment ?? '';
    document.getElementById('stepUp').value = state.stepUp ?? '';
    document.getElementById('growthRate').value = state.growthRate ?? '';
    document.getElementById('inflationRate').value = state.inflationRate ?? '';
    document.getElementById('tenureValue').value = state.tenureValue ?? '';
    updateTenureLabel();
    updateGrowthLabel();
  }

  function updateTenureLabel() {
    const freq = frequencySelect.value;
    tenureLabel.textContent = freq === 'yearly'
      ? 'Tenure of investment (years)'
      : 'Tenure of investment (months)';
  }

  function updateGrowthLabel() {
    const freq = frequencySelect.value;
    let base;
    if (currentAsset === 'gold') {
      base = 'Estimated gold price growth';
    } else if (currentAsset === 'stock') {
      base = 'Estimated stock price growth';
    } else {
      base = 'Estimated NAV growth';
    }
    const suffix = freq === 'yearly' ? ' (% per year)' : ' (% per month)';
    growthLabelEl.textContent = base + suffix;
  }

  function applyAssetConfig() {
    if (currentAsset === 'gold') {
      goldRateField.style.display = '';
      rateLabelEl.textContent = "Today's gold rate (₹ per gram)";
      qtySuffix = ' g';
      qtyHeaderEl.textContent = 'Gold accumulated (g)';
      summaryQtyLabelEl.textContent = 'Gold accumulated by end of tenure';
    } else if (currentAsset === 'stock') {
      goldRateField.style.display = '';
      rateLabelEl.textContent = "Today's stock price (₹ per share)";
      qtySuffix = ' units';
      qtyHeaderEl.textContent = 'Shares accumulated (units)';
      summaryQtyLabelEl.textContent = 'Shares accumulated by end of tenure';
    } else if (currentAsset === 'mf') {
      goldRateField.style.display = 'none';
      qtySuffix = ' units';
      qtyHeaderEl.textContent = 'Units accumulated';
      summaryQtyLabelEl.textContent = 'Units accumulated by end of tenure';
    }
    updateGrowthLabel();
  }

  // ===== Tab switching =====
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const asset = tab.getAttribute('data-asset');
      if (asset === currentAsset) return;

      if (currentAsset !== 'realestate') {
        tabState[currentAsset] = readFormState();
      }

      currentAsset = asset;

      tabs.forEach(t => {
        t.classList.toggle('active', t.getAttribute('data-asset') === asset);
      });

      if (asset === 'realestate') {
        sipSection.style.display = 'none';
        reSection.style.display = '';

        resultsContainer.style.display = 'none';
        tableBody.innerHTML = '';
        printBtn.style.display = 'none';
        errorBox.style.display = 'none';
      } else {
        sipSection.style.display = '';
        reSection.style.display = 'none';

        applyAssetConfig();
        applyFormState(tabState[asset] || {});
        resultsContainer.style.display = 'none';
        tableBody.innerHTML = '';
        printBtn.style.display = 'none';
        errorBox.style.display = 'none';
      }

      if (asset !== 'realestate') {
        reResults.style.display = 'none';
        reErrorBox.style.display = 'none';
        reTableBody.innerHTML = '';
        rePrintBtn.style.display = 'none';
        emiScheduleTitle.style.display = 'none';
        emiScheduleContainer.style.display = 'none';
        emiScheduleBody.innerHTML = '';
        reEmiSchedule = null;
      }
    });
  });

  frequencySelect.addEventListener('change', () => {
    updateTenureLabel();
    updateGrowthLabel();
  });

  applyAssetConfig();
  updateTenureLabel();

  // ===== Formatting helpers =====
  function formatReadableIndian(value) {
    if (!isFinite(value)) return '0';
    const abs = Math.abs(value);
    let short = value;
    let suffix = '';

    if (abs >= 1e7) {
      short = value / 1e7;
      suffix = ' Cr';
    } else if (abs >= 1e5) {
      short = value / 1e5;
      suffix = ' Lakh';
    } else if (abs >= 1e3) {
      short = value / 1e3;
      suffix = 'K';
    } else {
      short = value;
    }

    return short.toFixed(2) + suffix;
  }

  function formatCurrency(value) {
    if (!isFinite(value)) return '₹0';
    const full = value.toLocaleString('en-IN', {
      maximumFractionDigits: 2,
      minimumFractionDigits: 2
    });
    const short = formatReadableIndian(value);
    return `₹${full} (${short})`;
  }

  function formatNumber(value, digits = 2) {
    if (!isFinite(value)) return '0';
    return value.toLocaleString('en-IN', {
      maximumFractionDigits: digits,
      minimumFractionDigits: digits
    });
  }

  // ===== SIP calculator =====
  function calculatePlan() {
    if (currentAsset === 'realestate') return;

    errorBox.style.display = 'none';
    errorBox.textContent = '';
    resultsContainer.style.display = 'none';
    tableBody.innerHTML = '';
    printBtn.style.display = 'none';

    const goldRateRaw = parseFloat(document.getElementById('goldRate').value);
    const frequency = frequencySelect.value;
    const plannedInvestment = parseFloat(document.getElementById('plannedInvestment').value);
    const stepUpPercent = parseFloat(document.getElementById('stepUp').value) || 0;
    const growthRatePercent = parseFloat(document.getElementById('growthRate').value);
    const inflationRatePercent = parseFloat(document.getElementById('inflationRate').value);
    const tenureValue = parseInt(document.getElementById('tenureValue').value, 10);

    if ((currentAsset !== 'mf' && (!goldRateRaw || goldRateRaw <= 0)) ||
        !plannedInvestment || plannedInvestment <= 0 ||
        !tenureValue || tenureValue <= 0 ||
        isNaN(growthRatePercent) ||
        isNaN(inflationRatePercent)) {
      errorBox.textContent = 'Please fill all required fields with valid numbers (price/NAV if needed, investment amount, tenure, growth & inflation).';
      errorBox.style.display = 'block';
      return;
    }

    let basePrice;
    if (currentAsset === 'mf') {
      basePrice = 1;
    } else {
      basePrice = goldRateRaw;
    }

    const stepUp = stepUpPercent / 100;
    const inflAnnual = inflationRatePercent / 100;

    const growthInput = growthRatePercent / 100;
    let growthPerPeriod, growthAnnual;

    if (frequency === 'yearly') {
      growthPerPeriod = growthInput;
      growthAnnual = growthInput;
    } else {
      growthPerPeriod = growthInput;
      growthAnnual = Math.pow(1 + growthInput, 12) - 1;
    }

    let tenureYears, periods, periodsPerYear;
    if (frequency === 'yearly') {
      tenureYears = tenureValue;
      periodsPerYear = 1;
      periods = tenureValue;
    } else {
      tenureYears = tenureValue / 12;
      periodsPerYear = 12;
      periods = tenureValue;
    }

    if (periods <= 0) {
      errorBox.textContent = 'Tenure is too short to simulate. Increase years/months.';
      errorBox.style.display = 'block';
      return;
    }

    let totalInvested = 0;
    let totalUnits = 0;

    for (let i = 0; i < periods; i++) {
      const yearIndex = (frequency === 'yearly') ? i : Math.floor(i / 12);

      const contributionThisPeriod = plannedInvestment * Math.pow(1 + stepUp, yearIndex);
      const priceThisPeriod = basePrice * Math.pow(1 + growthPerPeriod, i);
      const unitsThisPeriod = contributionThisPeriod / priceThisPeriod;

      totalInvested += contributionThisPeriod;
      totalUnits += unitsThisPeriod;
    }

    const priceAtEndTenure = basePrice * Math.pow(1 + growthAnnual, tenureYears);
    const nominalEndValue = totalUnits * priceAtEndTenure;
    const realEndValue = nominalEndValue / Math.pow(1 + inflAnnual, tenureYears);

    document.getElementById('summaryInvested').textContent = formatCurrency(totalInvested);
    summaryQtyValueEl.textContent = formatNumber(totalUnits, 3) + qtySuffix;
    document.getElementById('summaryNominal').textContent = formatCurrency(nominalEndValue);
    document.getElementById('summaryReal').textContent = formatCurrency(realEndValue);

    function computeTotalsUpToYears(hYears) {
      let invested = 0;
      let units = 0;
      for (let i = 0; i < periods; i++) {
        const tYears = (frequency === 'yearly') ? i : i / 12;
        if (tYears >= hYears - 1e-9) break;

        const yearIndex = (frequency === 'yearly') ? i : Math.floor(i / 12);

        const contributionThisPeriod = plannedInvestment * Math.pow(1 + stepUp, yearIndex);
        const priceThisPeriod = basePrice * Math.pow(1 + growthPerPeriod, i);
        const unitsThisPeriod = contributionThisPeriod / priceThisPeriod;

        invested += contributionThisPeriod;
        units += unitsThisPeriod;
      }
      return { invested, units };
    }

    for (let y = 5; y < tenureYears - 1e-9; y += 5) {
      const { invested, units } = computeTotalsUpToYears(y);
      const priceAtHorizon = basePrice * Math.pow(1 + growthAnnual, y);
      const nominalValue = units * priceAtHorizon;
      const realValue = nominalValue / Math.pow(1 + inflAnnual, y);

      const tr = document.createElement('tr');
      const appendCell = (text) => {
        const td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      };

      appendCell(`After ${y} years`);
      appendCell(formatNumber(units, 3) + qtySuffix);
      appendCell(formatCurrency(invested));
      appendCell(formatCurrency(nominalValue));
      appendCell(formatCurrency(realValue));

      tableBody.appendChild(tr);
    }

    const horizons = [
      { label: `End of tenure (${formatNumber(tenureYears, 1)} yrs)`, extraYears: 0 },
      { label: `Tenure + 5 years`, extraYears: 5 },
      { label: `Tenure + 15 years`, extraYears: 15 },
      { label: `Tenure + 20 years`, extraYears: 20 },
      { label: `Tenure + 25 years`, extraYears: 25 }
    ];

    horizons.forEach(h => {
      const totalYearsFromToday = tenureYears + h.extraYears;

      const priceAtHorizon = basePrice * Math.pow(1 + growthAnnual, totalYearsFromToday);
      const nominalValue = totalUnits * priceAtHorizon;
      const realValue = nominalValue / Math.pow(1 + inflAnnual, totalYearsFromToday);

      const tr = document.createElement('tr');
      if (h.extraYears === 0) tr.classList.add('tenure-row');

      const appendCell = (text) => {
        const td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      };

      appendCell(h.label);
      appendCell(formatNumber(totalUnits, 3) + qtySuffix);
      appendCell(formatCurrency(totalInvested));
      appendCell(formatCurrency(nominalValue));
      appendCell(formatCurrency(realValue));

      tableBody.appendChild(tr);
    });

    resultsContainer.style.display = 'block';
    printBtn.style.display = 'inline-flex';
  }

  // ===== Real Estate calculator =====
  function calculateRealEstate() {
    if (currentAsset !== 'realestate') return;

    reErrorBox.style.display = 'none';
    reErrorBox.textContent = '';
    reResults.style.display = 'none';
    reTableBody.innerHTML = '';
    rePrintBtn.style.display = 'none';
    reEmiSchedule = null;
    emiScheduleTitle.style.display = 'none';
    emiScheduleContainer.style.display = 'none';
    emiScheduleBody.innerHTML = '';

    const propertyValue = parseFloat(document.getElementById('rePropertyValue').value);
    const investedSavings = parseFloat(document.getElementById('reInvestedSavings').value) || 0;
    const loanAmount = parseFloat(document.getElementById('reLoanAmount').value) || 0;
    const interestRate = parseFloat(document.getElementById('reInterestRate').value) || 0;
    const loanTenureYears = parseInt(document.getElementById('reLoanTenure').value, 10);
    const rentPerMonthInitial = parseFloat(document.getElementById('reRentPerMonth').value) || 0;
    const rentIncrease = parseFloat(document.getElementById('reRentIncrease').value) || 0;
    const inflPercent = parseFloat(document.getElementById('reInflation').value);
    const appPercent = parseFloat(document.getElementById('reAppreciation').value);

    if (!propertyValue || propertyValue <= 0 ||
        !loanTenureYears || loanTenureYears <= 0 ||
        isNaN(inflPercent) ||
        isNaN(appPercent)) {
      reErrorBox.textContent = 'Please fill property value, loan tenure, inflation & appreciation with valid numbers. Other fields can be 0 if not applicable.';
      reErrorBox.style.display = 'block';
      return;
    }

    const inflRate = inflPercent / 100;
    const appRate = appPercent / 100;

    let totalPrincipalPaid = 0;
    let totalInterestPaid = 0;
    let totalEmiPaid = 0;
    const cumulativeEmiAtYear = {};
    let approxFirstEmi = 0;
    reEmiSchedule = [];

    // ---- EMI schedule & totals (standard amortization) ----
    if (loanAmount > 0) {
      const nMonths = loanTenureYears * 12;
      const monthlyRate = interestRate > 0 ? (interestRate / 100 / 12) : 0;

      let emiBase;
      if (monthlyRate > 0) {
        const factor = Math.pow(1 + monthlyRate, nMonths);
        emiBase = loanAmount * monthlyRate * factor / (factor - 1);
      } else {
        emiBase = loanAmount / nMonths;
      }

      let principalOutstanding = loanAmount;
      let cumulativeEmi = 0;
      let cumulativePrincipal = 0;

      const startDate = new Date();
      const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

      for (let m = 1; m <= nMonths; m++) {
        const interestBase = principalOutstanding * monthlyRate;
        let principalComponent;
        let baseEmiThisMonth = emiBase;

        if (monthlyRate > 0) {
          principalComponent = baseEmiThisMonth - interestBase;
          if (principalComponent > principalOutstanding) {
            principalComponent = principalOutstanding;
            baseEmiThisMonth = principalComponent + interestBase;
          }
        } else {
          principalComponent = loanAmount / nMonths;
          baseEmiThisMonth = principalComponent;
        }

        const interestTotal = interestBase;
        const emiTotal = principalComponent + interestTotal;

        principalOutstanding -= principalComponent;
        if (principalOutstanding < 1e-6) principalOutstanding = 0;

        cumulativeEmi += emiTotal;
        cumulativePrincipal += principalComponent;

        const yearIndex = Math.ceil(m / 12);
        cumulativeEmiAtYear[yearIndex] = cumulativeEmi;

        const d = new Date(startDate);
        d.setMonth(d.getMonth() + (m - 1));
        const periodLabel = `${monthNames[d.getMonth()]}-${d.getFullYear()}`;

        reEmiSchedule.push({
          month: m,
          periodLabel,
          principalPending: principalOutstanding,
          principalPaid: principalComponent,
          interestPaid: interestTotal,
          emiTotal,
          cumEmi: cumulativeEmi,
          cumPrincipal: cumulativePrincipal
        });

        totalPrincipalPaid += principalComponent;
        totalInterestPaid += interestTotal;
        totalEmiPaid += emiTotal;
      }

      approxFirstEmi = reEmiSchedule.length > 0 ? reEmiSchedule[0].emiTotal : 0;
    }

    const totalLoanPayout = totalPrincipalPaid + totalInterestPaid;
    const totalCashOutflow = investedSavings + totalLoanPayout;

    reSummarySavings.textContent = formatCurrency(investedSavings);
    reSummaryEmi.textContent = approxFirstEmi > 0 ? formatCurrency(approxFirstEmi) : '₹0';
    reSummaryPrincipal.textContent = formatCurrency(totalPrincipalPaid);
    reSummaryInterest.textContent = formatCurrency(totalInterestPaid);
    reSummaryLoanPayout.textContent = formatCurrency(totalLoanPayout);
    reSummaryTotalOutflow.textContent = formatCurrency(totalCashOutflow);

    // ---- Rent (earned) ----
    const rentIncRate = rentIncrease / 100;
    const maxYears = 40;
    const cumulativeRentAtYear = {};
    let monthlyRent = rentPerMonthInitial;
    let cumRent = 0;

    for (let y = 1; y <= maxYears; y++) {
      if (y === 1) {
        monthlyRent = rentPerMonthInitial;
      } else {
        monthlyRent = monthlyRent * (1 + rentIncRate);
      }
      const annualRent = monthlyRent * 12;
      cumRent += annualRent;
      cumulativeRentAtYear[y] = cumRent;
    }

    const totalRentOverLoan = cumulativeRentAtYear[loanTenureYears] || 0;

    // ---- Property appreciation ----
    const propValueEndNominal = propertyValue * Math.pow(1 + appRate, loanTenureYears);
    const propValueEndReal = propValueEndNominal / Math.pow(1 + inflRate, loanTenureYears);

    reSummaryRent.textContent = formatCurrency(totalRentOverLoan);
    reSummaryPropNominal.textContent = formatCurrency(propValueEndNominal);
    reSummaryPropReal.textContent = formatCurrency(propValueEndReal);

    // ---- Projections table ----
    const horizons = [5, 10, 15, 20, 25, 30, 35, 40];
    horizons.forEach(years => {
      const y = years;

      let loanPaidSoFar = 0;
      if (loanAmount > 0) {
        if (y >= loanTenureYears) {
          loanPaidSoFar = totalEmiPaid;
        } else {
          loanPaidSoFar = cumulativeEmiAtYear[y] || 0;
        }
      }

      const rentReceivedSoFar = cumulativeRentAtYear[y] || cumulativeRentAtYear[maxYears] || 0;

      const assetValueNominal = propertyValue * Math.pow(1 + appRate, y);
      const assetValueReal = assetValueNominal / Math.pow(1 + inflRate, y);

      const tr = document.createElement('tr');
      if (y === loanTenureYears) {
        tr.classList.add('tenure-row');
      }

      const appendCell = (text) => {
        const td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      };

      appendCell(`${y} years`);
      appendCell(formatCurrency(loanPaidSoFar));
      appendCell(formatCurrency(rentReceivedSoFar));
      appendCell(formatCurrency(assetValueNominal));
      appendCell(formatCurrency(assetValueReal));

      reTableBody.appendChild(tr);
    });

    // ---- EMI schedule table (only if loanAmount > 0) ----
    if (loanAmount > 0 && reEmiSchedule && reEmiSchedule.length > 0) {
      emiScheduleBody.innerHTML = '';

      reEmiSchedule.forEach(row => {
        const tr = document.createElement('tr');

        const principalPct = loanAmount > 0
          ? (row.cumPrincipal / loanAmount) * 100
          : 0;

        const loanPct = totalEmiPaid > 0
          ? (row.cumEmi / totalEmiPaid) * 100
          : 0;

        const cells = [
          row.month,
          row.periodLabel,
          formatCurrency(row.principalPaid),
          formatCurrency(row.interestPaid),
          formatCurrency(row.emiTotal),
          formatCurrency(row.principalPending),
          formatNumber(principalPct, 2) + ' %',
          formatNumber(loanPct, 2) + ' %'
        ];

        cells.forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        });

        emiScheduleBody.appendChild(tr);
      });

      emiScheduleTitle.style.display = 'block';
      emiScheduleContainer.style.display = 'block';
    } else {
      emiScheduleTitle.style.display = 'none';
      emiScheduleContainer.style.display = 'none';
      emiScheduleBody.innerHTML = '';
    }

    reResults.style.display = 'block';
    rePrintBtn.style.display = 'inline-flex';
  }
</script>
</body>
</html>
